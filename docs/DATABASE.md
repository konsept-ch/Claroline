**Overview**
- **Engine:** MySQL 8.0 (MariaDB not officially targeted here).
- **ORM:** Doctrine ORM with annotations in `src/**/Entity`.
- **Migrations:** Doctrine Migrations, organized per bundle. Each bundle holds its own migrations and tracking table.
- **Fixtures/Seeding:** Some bundles ship DataFixtures; dev seeding scripts create demo users.

**Where Things Live**
- **Entities:** `src/**/Entity/**.php`
- **Migrations (per bundle):** `src/**/Installation/Migrations/pdo_mysql/Version*.php`
- **Migration tracking tables (one per bundle):** `doctrine_<bundle_name>_versions` (e.g. `doctrine_clarolinecorebundle_versions`).
- **Custom migration tooling:** `src/main/migration/**` (ClarolineMigrationBundle) wraps Doctrine Migrations with bundle‑aware commands.

**Configuration**
- **DB params file:** `config/parameters.yml` (generated by `bin/configure`).
  - Env vars used at generation time: `DB_HOST`, `DB_NAME`, `DB_USER`, `DB_PASSWORD`.
  - Template with defaults: `config/parameters.yml.dist` (includes `database_version: 8.0`).
- **Doctrine config (suggested per env):**
  - `src/main/app/Resources/config/suggested/doctrine_prod.yml`
  - `src/main/app/Resources/config/suggested/doctrine_dev.yml`
  - `src/main/app/Resources/config/suggested/doctrine_test.yml`
  - Sets charset, mapping types and disables ONLY_FULL_GROUP_BY at connect time.

**Docker (dev)**
- Compose file: `docker-compose.dev.yml`.
- `db` service: `mysql:8.0`, port `3307->3306`, database/user/password `claroline`.
- `web` service injects env vars consumed by `bin/configure` on first install.

**Install / Update Flow**
- Single entry point: `php bin/console claroline:update`.
  - Internally uses the `PlatformInstaller` to:
    - Ensure DB exists, then iterate all installable bundles.
    - For each bundle, run pending migrations and load fixtures when present.
    - Track installation/update status via `Plugin` records and migration tables.
- Migration commands (bundle‑scoped):
  - `php bin/console claroline:migration:version <Bundle>`: show/adjust state.
    - `--latest` mark DB as at latest migration without running SQL.
    - `--all` mark every listed migration as executed.
  - `php bin/console claroline:migration:upgrade <Bundle> --target=farthest`: run all pending up migrations for that bundle.
  - `php bin/console claroline:migration:downgrade <Bundle> --target=farthest`: run down migrations (avoid unless you know the impact).

**Seeding / Demo Users**
- Script: `scripts/seed-dev.sh` creates `admin` and `demo1..demoN` users.
- Manual user creation: `php bin/console claroline:user:create Firstname Lastname username password email`.

**Troubleshooting After Importing a Database**
When a DB dump comes from another branch/version, migration tracking tables can be out of sync with this codebase, which may trigger attempts to drop or alter objects unexpectedly.

- **1) Verify connectivity and env**
  - Check `config/parameters.yml` (or re‑generate with `php bin/console cache:clear && php bin/configure`).
  - For Docker, confirm `db` port and credentials match your client.

- **2) Inspect migration state per bundle**
  - Example: `php bin/console claroline:migration:version ClarolineCoreBundle`.
  - If the imported schema is already at the right level but the tracker isn’t, align it without running SQL:
    - `php bin/console claroline:migration:version ClarolineCoreBundle --latest`
    - Repeat for other bundles that appear in `src/**/Installation/Migrations/pdo_mysql`.

- **3) Bring the schema forward, never backward**
  - If you’re behind this branch, prefer upgrading:
    - `php bin/console claroline:migration:upgrade <Bundle> --target=farthest`
  - Avoid downgrades; they may try to drop tables and fail due to FKs.

- **4) Reconcile globally**
  - Run `php bin/console claroline:update -c` to execute remaining updates, rebuild assets, and clear cache.

- **5) Investigate “cannot drop table” errors**
  - This usually indicates a downgrade or mismatched migration state.
  - Check which migration wants to drop objects: open the corresponding `Version*.php` in the bundle’s migrations folder.
  - Fix by aligning the tracker (step 2) or by upgrading (step 3). Only as a last resort, temporarily disable FKs to manually clean stray tables, then realign trackers:
    - `SET FOREIGN_KEY_CHECKS=0; ... cleanup ...; SET FOREIGN_KEY_CHECKS=1;`

- **6) Check migration tables directly (optional)**
  - `SELECT * FROM doctrine_clarolinecorebundle_versions ORDER BY version;`
  - Expect exactly one row per executed migration version per bundle.

**Quick Recovery Playbook**
- Imported DB from wrong branch → drop DB and import the correct dump.
- Then:
  1. `php bin/console claroline:migration:version ClarolineCoreBundle --latest` (and for other bundles as needed) if the dump is already up‑to‑date.
  2. Or run `claroline:migration:upgrade <Bundle> --target=farthest` to apply missing ups.
  3. `php bin/console claroline:update -c`.
  4. Seed users if needed: `scripts/seed-dev.sh` or `claroline:user:create`.

**Useful Commands**
- Show commands: `php bin/console list claroline`.
- Core bundle status: `php bin/console claroline:migration:version ClarolineCoreBundle`.
- Full install/update: `php bin/console claroline:update -c`.
- Create admin: `php bin/console claroline:user:create -a Admin User admin admin admin@example.com`.

If you want, I can now run a migration status sweep and propose exact version adjustments for the bundles present in your dump.

**GUI Clients**
- MySQL Workbench connection for Docker dev:
  - Host: `127.0.0.1`
  - Port: `3307`
  - User: `claroline`
  - Password: `claroline`
  - Default schema: `claroline`
  - Leave “Remote Management” and “System Profile” empty/disabled.

**Reset + Troubleshooting**
- Full reset (purge persisted data):
  - `docker compose -f docker-compose.dev.yml down --remove-orphans`
  - Delete `../mysql` directory (bind mount for `/var/lib/mysql`).
  - `docker compose -f docker-compose.dev.yml up -d`
  - Install: `docker exec -it claroline-web bash -lc 'php bin/console claroline:update -c'`
- Drop/recreate only:
  - `docker exec -it claroline-db mysql -uroot -pclaroline -e "DROP DATABASE IF EXISTS claroline; CREATE DATABASE claroline CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"`
  - Then run `claroline:update -c` in `claroline-web`.
- Common non-blocking warnings in logs:
  - `World-writable config file '/etc/mysql/conf.d/my.cnf' is ignored` (dev bind mount permissions; safe to ignore).
  - Time zone data “Unable to load … tzdata” (no tzdata in image; safe to ignore for dev).
  - `root@localhost is created with an empty password` appears during init; the entrypoint then sets the configured password.

**Importing a Dump**
- From host CLI: `mysql -h 127.0.0.1 -P 3307 -u claroline -pclaroline claroline < dump.sql`
- From container: `docker exec -i claroline-db mysql -uroot -pclaroline claroline < dump.sql`
- From Workbench: connect to `127.0.0.1:3307` → Server > Data Import → Import from self‑contained file → Default Target Schema `claroline` → Start Import.
- After import, align migrations to this codebase if needed:
  - Mark latest (when dump is already up-to-date): `docker exec -it claroline-web bash -lc 'php bin/console claroline:migration:version ClarolineCoreBundle --latest'`
  - Or upgrade pending migrations: `docker exec -it claroline-web bash -lc 'php bin/console claroline:migration:upgrade ClarolineCoreBundle --target=farthest'`
  - Then run: `docker exec -it claroline-web bash -lc 'php bin/console claroline:update -c'`

Important: import into an empty database
- If you import over a DB created by `claroline:update`, you will get duplicate key errors (e.g., `Duplicate entry '1' for key 'claro_admin_tools.PRIMARY'`).
- Always drop/recreate the `claroline` schema first:
  - `docker exec -it claroline-db mysql -uroot -pclaroline -e "DROP DATABASE IF EXISTS claroline; CREATE DATABASE claroline CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;"`
- In Workbench: run the same DROP/CREATE in a SQL Editor tab before using “Data Import”.
